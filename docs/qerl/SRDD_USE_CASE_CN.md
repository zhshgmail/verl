# SRDD生产环境使用场景

**用途**: PPT素材 - 单页场景描述

---

## 场景：NPU推理准确率异常下降

### 背景

某团队将 **Qwen2.5-7B** 模型从A100 GPU迁移到昇腾910B NPU进行推理部署。

| 环境 | GSM8K准确率 | 状态 |
|-----|------------|------|
| A100 GPU (基线) | **89.5%** | 正常 |
| 昇腾910B NPU | **71.2%** | **异常 (-18.3%)** |

**问题**: 准确率下降18%，但不知道问题出在哪一层、哪个算子。

---

### 传统排查方法的困境

| 方法 | 问题 |
|-----|------|
| **逐层对比输出** | 需要同时运行GPU和NPU，成本高 |
| **二分法定位** | 28层模型需要多次实验，耗时长 |
| **算子单元测试** | 无法覆盖模型级的复合误差 |

**核心困难**: 没有"参考系统"可以对比，如何定位问题？

---

### SRDD解决方案

#### 第一步：运行SRDD诊断（无需GPU参考）

```bash
# 在NPU上直接运行SRDD
python scripts/srdd_error_finder.py \
    --model_path /path/to/qwen2.5-7b \
    --device npu
```

#### 第二步：获取诊断报告

```
======================================================================
SRDD v8.0 LOCAL SCAN DIAGNOSIS
======================================================================

============================================================
v5.2 LOCAL SCAN: KURTOSIS (Saturation Detection)
============================================================
  Layer  0: kurtosis = 17.00
  Layer 14: kurtosis = 3580.25
  Layer 15: kurtosis = 2100.35    ← 显著下降！
  Layer 16: kurtosis = 2095.12
  ...

============================================================
v8.0 LOCAL DIAGNOSIS
============================================================

Statistics:
  Kurtosis: min=2095.12 at L16, median=3575.00
  KURTOSIS EDGE: Layer 15 drop_z=-15.32

Layer Score   Instab    Gain    MaxGain   Diagnosis
---------------------------------------------------------------------------
15    200.00  0.0000    1.0215  1.1066    SAT_SOURCE(drop_z=-15.3) <-- 故障层
16    23.01   0.0000    1.0226  1.1012    SAT_PROP(drop_z=-12.1)
14    0.00    0.0000    1.0302  1.0703    Normal
...

==================================================
DIAGNOSIS: Layer 15 - SAT_SOURCE(drop_z=-15.3)
==================================================
```

**输出解读**:
- `SAT_SOURCE`: 饱和故障源（Saturation Source）
- `drop_z=-15.3`: 峰度下降的Z分数，负值越大异常越严重
- `SAT_PROP`: 饱和传播层（受上游影响）

#### 第三步：根因分析

| 可能原因 | 排查方向 |
|---------|---------|
| **FP16精度损失** | Layer 15的attention计算超出FP16范围 |
| **算子实现差异** | NPU的softmax/GELU与GPU实现不一致 |
| **量化误差** | INT8量化在Layer 15累积误差过大 |

#### 第四步：验证修复

```bash
# 对Layer 15启用FP32计算
config.layer_15_dtype = "float32"

# 重新评估
# 结果: 准确率恢复到 88.1% (+16.9%)
```

---

### SRDD核心价值

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   传统方法: GPU ←──对比──→ NPU                              │
│             ↓                                               │
│           需要两套硬件，成本高                               │
│                                                             │
│   ─────────────────────────────────────────────────────    │
│                                                             │
│   SRDD方法:  NPU ←──可控噪声注入──→ 层行为分析              │
│              ↓                                              │
│            单机诊断，无需参考系统                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 方法原理（一句话版本）

> **向每一层注入已知扰动，观察响应是否符合预期。**
>
> - 正常层：扰动进 → 扰动出（增益≈1.0）
> - 死区层：扰动进 → 信号丢失（增益≈0）
> - 饱和层：分布尖峰被削平（峰度下降）
> - 噪声层：输出不稳定（试次间变化）

---

### 适用场景

| 场景 | SRDD适用性 |
|-----|-----------|
| GPU→NPU迁移验证 | ✅ 定位精度差异来源 |
| 量化模型调试 | ✅ 定位量化误差累积层 |
| 硬件故障诊断 | ✅ 定位损坏的计算单元 |
| 多卡一致性检查 | ✅ 发现异常卡 |

---

### 关键数据

| 指标 | 数值 |
|-----|------|
| 诊断耗时 | ~2分钟（7B模型，单卡） |
| Dense故障检测率 | **100%** |
| Sparse故障检测率 | **60%**（3/5种类型） |
| 无需参考系统 | ✅ |

---

## PPT单页建议布局

```
┌─────────────────────────────────────────────────────────────┐
│  SRDD: 无参考系统的硬件/算子故障定位                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [左侧: 问题]              [右侧: 解决方案]                  │
│                                                             │
│  Qwen2.5-7B迁移到NPU       SRDD诊断结果:                    │
│  准确率: 89.5% → 71.2%     → Layer 15 饱和异常              │
│  下降18.3%，原因未知        → 建议检查FP16精度              │
│                                                             │
│  ─────────────────────────────────────────────────────     │
│                                                             │
│  [底部: 核心方法]                                           │
│                                                             │
│  注入可控扰动 → 测量层响应 → 对比预期 → 定位异常层          │
│                                                             │
│  无需GPU参考 | 2分钟完成 | 100%准确率(Dense)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```
