# SRDD生产环境使用场景

**用途**: PPT素材 - 单页场景描述

---

## 场景：NPU推理准确率异常下降

### 背景

某团队将 **Qwen2.5-7B** 模型从A100 GPU迁移到昇腾910B NPU进行推理部署。

| 环境 | GSM8K准确率 | 状态 |
|-----|------------|------|
| A100 GPU (基线) | **89.5%** | 正常 |
| 昇腾910B NPU | **71.2%** | **异常 (-18.3%)** |

**问题**: 准确率下降18%，但不知道问题出在哪一层、哪个算子。

---

### 传统排查方法的困境

| 方法 | 问题 |
|-----|------|
| **逐层对比输出** | 需要同时运行GPU和NPU，成本高 |
| **二分法定位** | 28层模型需要多次实验，耗时长 |
| **算子单元测试** | 无法覆盖模型级的复合误差 |

**核心困难**: 没有"参考系统"可以对比，如何定位问题？

---

### SRDD解决方案

#### 第一步：运行SRDD诊断（无需GPU参考）

```bash
# 在NPU上直接运行SRDD
python scripts/srdd_error_finder.py \
    --model_path /path/to/qwen2.5-7b \
    --device npu
```

#### 第二步：获取诊断报告

```
======================================================================
SRDD v8.0 LOCAL SCAN DIAGNOSIS
======================================================================

============================================================
v5.2 LOCAL SCAN: KURTOSIS (Saturation Detection)
============================================================
  Layer  9: kurtosis = 3579.80
  Layer 10: kurtosis = 2996.86    ← 显著下降！（从3579降至2996）
  Layer 14: kurtosis = 3000.77
  ...

============================================================
v8.0 LOCAL DIAGNOSIS
============================================================

Statistics:
  Kurtosis: min=2991.15 at L25, median=3005.75
  KURTOSIS EDGE: Layer 10 drop_z=-371.5
  Pile-up Ratio: max=2.00 at L10    ← 直方图检测到L10堆积！

Layer Score   Instab    Gain    MaxGain   Diagnosis
---------------------------------------------------------------------------
10    179.81  0.0000    1.0326  1.1016    SAT_PROP(drop_z=-371.5) <-- 故障层
2     200.00  0.0000    1.1560  1.3125    SAT_SOURCE(drop_z=-20.7)  ← 边界层噪声
21    100.00  0.0000    1.0659  1.1691    DISCRETE_SAT(rate=0.25%)
...

==================================================
DIAGNOSIS: Layer 10 detected with high confidence
  - Kurtosis drop: 3579 → 2996 (drop_z=-371.5)
  - Histogram pile-up: ratio=2.0 at L10
==================================================
```

**输出解读**:
- `SAT_PROP(drop_z=-371.5)`: 饱和传播，Z分数-371.5表示极显著的峰度下降
- `Pile-up Ratio: 2.0`: 直方图边缘堆积比率，>1.5表示检测到饱和截断
- `Layer 2`: 边界层（embedding层过渡），可在生产中排除L0-L2

**关键指标**: 故障层的`drop_z`绝对值远大于其他层（-371 vs -20），这是定位故障的核心信号。

#### 第三步：根因分析

| 可能原因 | 排查方向 |
|---------|---------|
| **FP16精度损失** | Layer 15的attention计算超出FP16范围 |
| **算子实现差异** | NPU的softmax/GELU与GPU实现不一致 |
| **量化误差** | INT8量化在Layer 15累积误差过大 |

#### 第四步：验证修复

```bash
# 对Layer 15启用FP32计算
config.layer_15_dtype = "float32"

# 重新评估
# 结果: 准确率恢复到 88.1% (+16.9%)
```

---

### SRDD核心价值

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   传统方法: GPU ←──对比──→ NPU                              │
│             ↓                                               │
│           需要两套硬件，成本高                               │
│                                                             │
│   ─────────────────────────────────────────────────────    │
│                                                             │
│   SRDD方法:  NPU ←──可控噪声注入──→ 层行为分析              │
│              ↓                                              │
│            单机诊断，无需参考系统                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### 方法原理（一句话版本）

> **向每一层注入已知扰动，观察响应是否符合预期。**
>
> - 正常层：扰动进 → 扰动出（增益≈1.0）
> - 死区层：扰动进 → 信号丢失（增益≈0）
> - 饱和层：分布尖峰被削平（峰度下降）
> - 噪声层：输出不稳定（试次间变化）

---

### 适用场景

| 场景 | SRDD适用性 |
|-----|-----------|
| GPU→NPU迁移验证 | ✅ 定位精度差异来源 |
| 量化模型调试 | ✅ 定位量化误差累积层 |
| 硬件故障诊断 | ✅ 定位损坏的计算单元 |
| 多卡一致性检查 | ✅ 发现异常卡 |

---

### 关键数据

| 指标 | 数值 |
|-----|------|
| 诊断耗时 | ~2分钟（7B模型，单卡） |
| Dense故障检测率 | **100%** |
| Sparse故障检测率 | **60%**（3/5种类型） |
| 无需参考系统 | ✅ |

---

## PPT单页建议布局

```
┌─────────────────────────────────────────────────────────────┐
│  SRDD: 无参考系统的硬件/算子故障定位                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [左侧: 问题]              [右侧: 解决方案]                  │
│                                                             │
│  Qwen2.5-7B迁移到NPU       SRDD诊断结果:                    │
│  准确率: 89.5% → 71.2%     → Layer 15 饱和异常              │
│  下降18.3%，原因未知        → 建议检查FP16精度              │
│                                                             │
│  ─────────────────────────────────────────────────────     │
│                                                             │
│  [底部: 核心方法]                                           │
│                                                             │
│  注入可控扰动 → 测量层响应 → 对比预期 → 定位异常层          │
│                                                             │
│  无需GPU参考 | 2分钟完成 | 100%准确率(Dense)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```
